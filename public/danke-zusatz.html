<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danke! | Pfoten-Plan</title>
    <link rel="icon" type="image/png" href="favconHund.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FAF8F5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 420px;
            text-align: center;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #22C55E, #16A34A);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
            animation: pop 0.5s ease;
        }

        @keyframes pop {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .success-icon svg {
            width: 40px;
            height: 40px;
            color: white;
        }

        h1 {
            font-size: 26px;
            color: #1a1a1a;
            margin-bottom: 12px;
        }

        .dog-name {
            color: #C4A576;
        }

        .subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .order-box {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            text-align: left;
            margin-bottom: 24px;
        }

        .order-title {
            font-size: 14px;
            color: #999;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-icon {
            width: 44px;
            height: 44px;
            background: #FEF3E7;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .order-info h3 {
            font-size: 15px;
            color: #1a1a1a;
            margin-bottom: 2px;
        }

        .order-info p {
            font-size: 13px;
            color: #666;
        }

        .order-check {
            margin-left: auto;
            color: #22C55E;
            font-size: 20px;
        }

        .email-note {
            font-size: 14px;
            color: #666;
            background: #F8F8F8;
            padding: 16px;
            border-radius: 10px;
            line-height: 1.6;
        }

        .email-note strong {
            color: #1a1a1a;
        }

        .support-note {
            font-size: 13px;
            color: #999;
            text-align: center;
            margin-top: 16px;
        }

        .support-note a {
            color: #C4A576;
            text-decoration: none;
        }

        .support-note a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="success-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
            </svg>
        </div>

        <h1>Perfekt, <span class="dog-name">Luna</span>!</h1>
        <p class="subtitle">Dein erweitertes Training ist jetzt komplett.</p>

        <div class="order-box">
            <div class="order-title">Deine Bestellung</div>
            
            <div class="order-item" id="mainPlan">
                <div class="order-icon">üìã</div>
                <div class="order-info">
                    <h3 id="mainProblemName">Trainingsplan</h3>
                    <p>Hauptproblem</p>
                </div>
                <span class="order-check">‚úì</span>
            </div>

            <div class="order-item" id="upsellModule">
                <div class="order-icon" id="moduleIcon">üò∞</div>
                <div class="order-info">
                    <h3 id="moduleName">Zusatz-Modul</h3>
                    <p id="moduleDesc">8 √úbungen ‚Ä¢ 2 Wochen</p>
                </div>
                <span class="order-check">‚úì</span>
            </div>
        </div>

        <div class="email-note">
            üìß <strong>Beide Pl√§ne</strong> werden in wenigen Minuten an deine E-Mail gesendet.
        </div>

        <div class="support-note">
            Fragen? Schreib uns an <a href="mailto:support@pfoten-plan.de">support@pfoten-plan.de</a>
        </div>
    </div>

    <script>
        // Supabase Config
        const SUPABASE_URL = 'https://xomsibpyksrzrnixbdwf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvbXNpYnB5a3NyenJuaXhiZHdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NjMxMjIsImV4cCI6MjA3MjIzOTEyMn0.ZgCwog94HUHz39lbGMJkFPeZ6c-nL4AMFFTz5AgwnKE';

        // Hundename aus localStorage
        const dogName = localStorage.getItem('dogName') || 'dein Hund';
        document.querySelector('.dog-name').textContent = dogName;

        // Parameter aus URL
        const urlParams = new URLSearchParams(window.location.search);
        const module = urlParams.get('module');
        const leadId = urlParams.get('lead_id') || localStorage.getItem('leadId');

        // ALLE Module (inkl. fehlende)
        const moduleData = {
            'anxiety': { icon: 'üò∞', name: 'Trennungsangst Pr√§vention', exercises: '8 √úbungen' },
            'pulling': { icon: 'ü¶Æ', name: 'Leinenf√ºhrigkeit Basics', exercises: '6 √úbungen' },
            'barking': { icon: 'üîä', name: 'Anti-Bell Training', exercises: '6 √úbungen' },
            'aggression': { icon: 'üò§', name: 'Aggressions-Kontrolle', exercises: '8 √úbungen' },
            'recall': { icon: 'üì£', name: 'R√ºckruf-Training', exercises: '6 √úbungen' },
            'jumping': { icon: 'üêï', name: 'Anti-Anspring Training', exercises: '5 √úbungen' },
            'energy': { icon: '‚ö°', name: 'Energie-Management', exercises: '6 √úbungen' },
            'destructive': { icon: 'üß∏', name: 'Anti-Zerst√∂rungs Training', exercises: '6 √úbungen' },
            'mouthing': { icon: 'ü¶¥', name: 'Anti-Aufnehm Training', exercises: '6 √úbungen' }
        };

        if (module) {
            // Bundle erkennen (z.B. "pulling+anxiety")
            const isBundle = module.includes('+');
            
            let displayIcon, displayName, displayDesc, upsellValue;
            
            if (isBundle) {
                const modules = module.split('+');
                const mainModule = modules[0];
                displayIcon = 'üì¶';
                displayName = 'Komplett-Paket';
                displayDesc = (moduleData[mainModule]?.name || mainModule) + ' + Pr√§vention';
                upsellValue = module; // z.B. "pulling+anxiety"
            } else if (moduleData[module]) {
                displayIcon = moduleData[module].icon;
                displayName = moduleData[module].name;
                displayDesc = moduleData[module].exercises + ' ‚Ä¢ 2 Wochen';
                upsellValue = module;
            } else {
                displayIcon = 'üìã';
                displayName = 'Zusatz-Modul';
                displayDesc = 'Erweitertes Training';
                upsellValue = module;
            }
            
            document.getElementById('moduleIcon').textContent = displayIcon;
            document.getElementById('moduleName').textContent = displayName;
            document.getElementById('moduleDesc').textContent = displayDesc;
            
            // Upsell-Modul in Supabase speichern - IMMER wenn module vorhanden
            if (leadId) {
                console.log('üîç Lead ID gefunden:', leadId);
                console.log('üì¶ Modul zu speichern:', upsellValue, '(Bundle:', isBundle, ')');

                fetch(`${SUPABASE_URL}/rest/v1/wauwerk_leads?id=eq.${leadId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        upsell_module: upsellValue
                    })
                }).then(response => {
                    console.log('üì° Supabase Response Status:', response.status);
                    if (response.ok || response.status === 204) {
                        console.log('‚úÖ Upsell-Modul gespeichert:', upsellValue);
                    } else {
                        response.text().then(text => console.error('‚ùå Supabase Fehler:', text));
                    }
                }).catch(err => {
                    console.error('‚ùå Supabase update error:', err);
                });
            } else {
                console.warn('‚ö†Ô∏è Keine lead_id gefunden! URL:', window.location.href);
                console.log('localStorage leadId:', localStorage.getItem('leadId'));
            }
        }

        // ERWEITERTE problemNames mit allen Custom-Keys
        const mainProblem = localStorage.getItem('dogProblem');
        const problemNames = {
            // Standard
            'pulling': 'Leinenziehen',
            'barking': '√úberm√§√üiges Bellen',
            'aggression': 'Aggression',
            'anxiety': 'Trennungsangst',
            'jumping': 'Anspringen',
            'recall': 'Kommt nicht zur√ºck',
            'energy': '√úberm√§√üige Energie',
            'destructive': 'Zerst√∂rerisches Verhalten',
            'soiling': 'In die Wohnung machen',
            'mouthing': 'Unerw√ºnschtes Aufnehmen',
            // Custom Angst
            'visitor-anxiety': 'Angst bei Besuch',
            'thunder-anxiety': 'Gewitterangst',
            'noise-sensitivity': 'Ger√§uschempfindlichkeit',
            'general-anxiety': 'Allgemeine √Ñngstlichkeit',
            'stranger-anxiety': 'Angst vor Fremden',
            'anxious-overreaction': '√Ñngstliche √úberreaktion',
            'separation': 'Trennungsangst',
            // Custom Jagd
            'chasing': 'Jagdverhalten',
            'chasing-movement': 'Jagt Bewegungen',
            'prey-drive': 'Starker Jagdtrieb',
            'chasing-cars': 'Jagt Autos/Fahrr√§der',
            // Custom Fressen
            'eating-unwanted': 'Frisst Unerw√ºnschtes',
            'eating-trash': 'Frisst aus dem M√ºll',
            'eating-objects': 'Frisst Gegenst√§nde',
            // Custom Reaktivit√§t
            'postman-reactive': 'Reaktiv auf Postboten',
            'dog-reactive': 'Reaktiv auf andere Hunde',
            'leash-reactive': 'Leinenreaktivit√§t',
            'overreaction': '√úberreaktion auf Reize',
            // Custom Sonstiges
            'vocalization': '√úberm√§√üiges Lautgeben',
            'resource-guarding': 'Ressourcenverteidigung',
            'biting': 'Bei√üen/Schnappen',
            'digging': 'Buddeln',
            'marking': 'Markieren in der Wohnung',
            'custom-other': 'Sonstiges Verhalten'
        };

        if (mainProblem) {
            const problemText = problemNames[mainProblem] || mainProblem;
            document.getElementById('mainProblemName').textContent = problemText + '-Training';
        }
    </script>
</body>
</html>