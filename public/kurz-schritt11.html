<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast geschafft! | Pfoten-Plan</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/favconHund.png">

<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "ufxcf43805");
</script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #FFFFFF; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .logo { margin-top: 50px; margin-bottom: 50px; display: flex; align-items: center; gap: 10px; }
        .logo img { width: 42px; height: 42px; border-radius: 10px; }
        .logo span { font-size: 22px; font-weight: 800; color: #2C2C2E; }
        .container { max-width: 450px; width: 100%; text-align: center; }
        h1 { font-size: 32px; font-weight: 800; color: #1a1a1a; margin-bottom: 40px; line-height: 1.3; }
        #dogName { color: #C4A576; }
        .email-input { width: 100%; padding: 20px 24px; font-size: 17px; border: 1px solid #E0E0E0; border-radius: 12px; outline: none; background: #F8F8F8; margin-bottom: 20px; }
        .email-input:focus { border-color: #C4A576; background: #FFFFFF; }
        .email-input::placeholder { color: #999; }
        .submit-btn { width: 100%; padding: 18px 30px; background: #C4A576; color: white; border: none; border-radius: 12px; font-size: 17px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
        .submit-btn:hover { background: #B8956A; }
        .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
        .privacy-note { display: flex; align-items: flex-start; gap: 12px; margin-top: 40px; text-align: left; max-width: 400px; }
        .lock-icon { font-size: 20px; color: #CCCCCC; flex-shrink: 0; margin-top: 2px; }
        .privacy-text { font-size: 14px; color: #999; line-height: 1.6; }
        .privacy-text a { color: #C4A576; text-decoration: underline; }
        .rating-section { margin-top: 50px; text-align: center; }
        .trustpilot-stars { display: flex; justify-content: center; gap: 2px; margin-bottom: 8px; }
        .star-box { width: 20px; height: 20px; background: #00B67A; display: flex; align-items: center; justify-content: center; }
        .star-box svg { width: 14px; height: 14px; fill: white; }
        .rating-text { font-size: 14px; color: #999; }
        @media (max-width: 500px) { h1 { font-size: 26px; } .logo { margin-top: 30px; margin-bottom: 40px; } }
    </style>
<script
  defer
  data-website-id="dfid_7GbGWYlC43BwGzuWkUdwp"
  data-domain="pfoten-plan.de"
  src="https://datafa.st/js/script.js">
</script>
</head>
<body>
    <div class="logo">
        <img src="logo.png" alt="Pfoten-Plan">
        <span>Pfoten-Plan</span>
    </div>

    <div class="container">
        <h1>Dein Plan f√ºr <span id="dogName">deinen Hund</span> ist bereit.<br>Wohin d√ºrfen wir ihn senden?</h1>

        <form id="emailForm">
            <input type="email" class="email-input" id="emailInput" placeholder="Deine E-Mail eingeben" required>
            <button type="submit" class="submit-btn" id="submitBtn">Plan anfordern</button>
        </form>

        <div class="privacy-note">
            <span class="lock-icon">üîí</span>
            <p class="privacy-text">Deine Daten sind sicher und werden nicht weitergegeben. <a href="datenschutz.html">Datenschutz</a></p>
        </div>

        <div class="rating-section">
            <div class="trustpilot-stars">
                <div class="star-box"><svg viewBox="0 0 24 24"><polygon points="12,1 15,9 23,9 17,14 19,22 12,17 5,22 7,14 1,9 9,9"/></svg></div>
                <div class="star-box"><svg viewBox="0 0 24 24"><polygon points="12,1 15,9 23,9 17,14 19,22 12,17 5,22 7,14 1,9 9,9"/></svg></div>
                <div class="star-box"><svg viewBox="0 0 24 24"><polygon points="12,1 15,9 23,9 17,14 19,22 12,17 5,22 7,14 1,9 9,9"/></svg></div>
                <div class="star-box"><svg viewBox="0 0 24 24"><polygon points="12,1 15,9 23,9 17,14 19,22 12,17 5,22 7,14 1,9 9,9"/></svg></div>
                <div class="star-box"><svg viewBox="0 0 24 24"><polygon points="12,1 15,9 23,9 17,14 19,22 12,17 5,22 7,14 1,9 9,9"/></svg></div>
            </div>
            <p class="rating-text">4,8 von 5 bei 3.400+ Hunden</p>
        </div>
    </div>

    <script>
        // Supabase Config
        const SUPABASE_URL = 'https://xomsibpyksrzrnixbdwf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvbXNpYnB5a3NyenJuaXhiZHdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NjMxMjIsImV4cCI6MjA3MjIzOTEyMn0.ZgCwog94HUHz39lbGMJkFPeZ6c-nL4AMFFTz5AgwnKE';

        // A/B Test: 50/50 Split
        function getABTestPage() {
            // Pr√ºfe ob schon eine Variante zugewiesen wurde
            let variant = localStorage.getItem('ab_test_pricing');
            if (!variant) {
                // 50/50 Zufall
                variant = Math.random() < 0.5 ? 'A' : 'B';
                localStorage.setItem('ab_test_pricing', variant);
            }
            // A = deinplan.html (Tagespreis gro√ü), B = deinplan2.html (optimiert)
            return variant === 'A' ? 'deinplan.html' : 'deinplan2.html';
        }

        // Hundename aus localStorage
        const dogName = localStorage.getItem('dogName');
        if (dogName) {
            document.getElementById('dogName').textContent = dogName + 's';
        }

        function parseJSON(str) {
            try { return JSON.parse(str || '[]'); } 
            catch(e) { return []; }
        }

        // Brevo Contact erstellen via API Route (sicher, kein API Key im Frontend)
        // Form Submit
        document.getElementById('emailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const email = document.getElementById('emailInput').value.trim();
            
            if (!email) return;
            
            // Button deaktivieren
            submitBtn.disabled = true;
            submitBtn.textContent = 'Wird gespeichert...';
            
            // E-Mail in localStorage
            localStorage.setItem('userEmail', email);
            
            // A/B Test Seite bestimmen
            const targetPage = getABTestPage();
            
            // Sicherheits-Timeout: Nach 5 Sekunden auf jeden Fall weiterleiten
            const redirectTimeout = setTimeout(() => {
                console.log('‚è±Ô∏è Timeout - redirecting anyway');
                window.location.href = targetPage;
            }, 5000);
            
            // Quiz-Daten
            const dogNameValue = localStorage.getItem('dogName') || '';
            const dogProblemKey = localStorage.getItem('dogProblem') || '';
            
            const answers = {
                email: email,
                dog_name: dogNameValue,
                dog_age: localStorage.getItem('dogAge'),
                dog_breed: localStorage.getItem('dogBreed'),
                dog_gender: localStorage.getItem('dogGender'),
                dog_goal: localStorage.getItem('dogGoal'),
                dog_problem: dogProblemKey,
                dog_behaviors: parseJSON(localStorage.getItem('dogBehaviors')),
                dog_commands: parseJSON(localStorage.getItem('dogCommands')),
                had_training: localStorage.getItem('hadTraining'),
                territorial_aggression: localStorage.getItem('territorialAggression'),
                utm_source: localStorage.getItem('utm_source') || null,
                utm_medium: localStorage.getItem('utm_medium') || null,
                utm_campaign: localStorage.getItem('utm_campaign') || null,
                fbclid: localStorage.getItem('fbclid') || null,
                ab_variant: localStorage.getItem('ab_test_pricing') || null
            };

            let leadId = null;

            // 1. Supabase speichern
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/wauwerk_leads`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        email: email,
                        dog_name: dogNameValue,
                        status: 'email_captured',
                        answers: answers,
                        ab_variant: localStorage.getItem('ab_test_pricing') || null
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data[0]?.id) {
                        leadId = data[0].id;
                        localStorage.setItem('leadId', leadId);
                        console.log('‚úÖ Lead saved:', leadId);
                    }
                }
            } catch (err) {
                console.log('Supabase error:', err);
            }
            
            // 2. Weiter zur Checkout-Seite
            clearTimeout(redirectTimeout);
            window.location.href = targetPage;
        });
    </script>
</body>
</html>