<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zusatzmodule | Pfoten-Plan</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/favconHund.png">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17806525009"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'AW-17806525009');
    </script>

    <!-- SOFORT PR√úFEN: Wurde Zahlung abgebrochen? -->
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const redirectStatus = urlParams.get('redirect_status');
            const paymentIntent = urlParams.get('payment_intent');
            
            // Wenn redirect_status vorhanden aber NICHT "succeeded" ‚Üí Zahlung abgebrochen
            if (redirectStatus && redirectStatus !== 'succeeded') {
                console.log('‚ùå Zahlung abgebrochen, redirect_status:', redirectStatus);
                // Zur√ºck zur Plan-Seite
                window.location.href = '/deinplan.html';
                return;
            }
            
            // Wenn payment_intent vorhanden aber kein redirect_status ‚Üí auch pr√ºfen
            // (Manche Payment Methods wie Klarna setzen redirect_status nicht immer)
            if (paymentIntent && !redirectStatus) {
                // Das ist okay - wir lassen es durchlaufen und pr√ºfen unten
                console.log('‚ÑπÔ∏è Payment Intent ohne redirect_status, pr√ºfe weiter...');
            }
        })();
    </script>

    <!-- Microsoft Clarity -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "ufxcf43805");
    </script> 

    <!-- Meta Pixel -->
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '864109602683515');
        fbq('track', 'PageView');
    </script>

    <!-- TikTok Pixel -->
    <script>
        !function (w, d, t) {
            w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for( var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};
            ttq.load('D4RFSQBC77U7SM7UL8A0');
        }(window, document, 'ttq');
    </script>

    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FAF8F5;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        /* Payment Popup Overlay */
        .payment-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .payment-overlay.active {
            display: flex;
        }

        .payment-popup {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .payment-header {
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .payment-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .payment-close {
            width: 28px;
            height: 28px;
            border: none;
            background: #f5f5f5;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
        }

        .payment-body {
            padding: 14px 20px;
        }

        .payment-product {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #FAFAFA;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .payment-product-icon {
            width: 44px;
            height: 44px;
            background: #FEF3E7;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .payment-product-info h3 {
            font-size: 14px;
            color: #1a1a1a;
            margin-bottom: 2px;
        }

        .payment-product-info p {
            font-size: 12px;
            color: #666;
        }

        .payment-product-price {
            margin-left: auto;
            font-size: 18px;
            font-weight: 700;
            color: #C4A576;
        }

        .payment-benefits {
            background: #F8F8F8;
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 12px;
        }

        .payment-benefit {
            font-size: 12px;
            color: #333;
            padding: 4px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .payment-benefit:first-child {
            padding-top: 0;
        }

        .payment-benefit:last-child {
            padding-bottom: 0;
        }

        #payment-element {
            margin-bottom: 12px;
        }

        .payment-error {
            background: #FEF2F2;
            color: #DC2626;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 12px;
            display: none;
        }

        .payment-error.visible {
            display: block;
        }

        .payment-btn {
            width: 100%;
            background: #C4A576;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .payment-btn:hover {
            background: #B8956A;
        }

        .payment-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .payment-guarantee {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 10px;
            font-size: 11px;
            color: #666;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success */
        .success-msg {
            text-align: center;
            margin-bottom: 28px;
        }

        .success-check {
            width: 56px;
            height: 56px;
            background: #22C55E;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 14px;
        }

        .success-check svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .success-msg h1 {
            font-size: 20px;
            color: #1a1a1a;
            margin-bottom: 6px;
        }

        .success-msg p {
            font-size: 14px;
            color: #666;
        }

        .dog-name {
            color: #C4A576;
            font-weight: 600;
        }

        /* Upsell Box */
        .upsell-box {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }

        .upsell-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .upsell-icon {
            width: 42px;
            height: 42px;
            background: #FEF3E7;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .upsell-header h2 {
            font-size: 15px;
            color: #1a1a1a;
            line-height: 1.4;
        }

        .upsell-stat {
            font-size: 13px;
            color: #666;
            margin-bottom: 16px;
            padding: 12px 14px;
            background: #FFF8F0;
            border-radius: 10px;
            border: 1px solid #E8DDD0;
            text-align: center;
            line-height: 1.5;
        }

        .upsell-stat strong {
            color: #C4A576;
            font-weight: 600;
        }

        .limited-offer-banner {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            color: #2E7D32;
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid #A5D6A7;
        }

        /* Options */
        .upsell-option {
            padding: 16px;
            background: #FAFAFA;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .option-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .option-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-icon {
            font-size: 20px;
        }

        .option-name {
            font-size: 15px;
            color: #1a1a1a;
            font-weight: 600;
        }

        .option-badge {
            font-size: 11px;
            color: #666;
            background: #E8E8E8;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .option-desc {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .option-points {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 14px;
        }

        .option-point {
            font-size: 12px;
            color: #444;
            background: white;
            padding: 4px 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .option-point::before {
            content: "‚úì";
            color: #22C55E;
            font-weight: 600;
        }

        .option-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 12px;
            border-top: 1px solid #E8E8E8;
        }

        .option-price {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-price-old {
            font-size: 14px;
            color: #999;
            text-decoration: line-through;
        }

        .option-price-new {
            font-size: 20px;
            font-weight: 700;
            color: #C4A576;
        }

        .option-btn {
            background: #C4A576;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-btn:hover {
            background: #B8956A;
        }

        /* Bundle Styles */
        .bundle-option {
            background: linear-gradient(135deg, #F5F0E8 0%, #FFFFFF 100%);
            border: 2px solid #C4A576;
            border-radius: 16px;
            padding: 28px 20px 20px 20px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .bundle-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: linear-gradient(135deg, #C4A576, #8B7355);
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 0 14px 0 12px;
        }

        .bundle-header {
            margin-bottom: 16px;
        }

        .bundle-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .bundle-subtitle {
            font-size: 13px;
            color: #666;
        }

        .bundle-modules {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .bundle-module {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: white;
            padding: 12px;
            border-radius: 10px;
        }

        .bundle-module-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .bundle-module-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .bundle-module-points {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .bundle-point {
            font-size: 11px;
            color: #555;
            background: #F5F5F5;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .bundle-point::before {
            content: "‚úì ";
            color: #22C55E;
            font-weight: 600;
        }

        .bundle-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 16px;
            border-top: 1px solid #E8E8E8;
        }

        .bundle-price {
            display: flex;
            flex-direction: column;
        }

        .bundle-price-old {
            font-size: 13px;
            color: #999;
            text-decoration: line-through;
        }

        .bundle-price-new {
            font-size: 24px;
            font-weight: 700;
            color: #C4A576;
        }

        .bundle-price-save {
            font-size: 11px;
            color: #22C55E;
            font-weight: 600;
        }

        .bundle-btn {
            background: linear-gradient(135deg, #C4A576, #8B7355);
            border: none;
            color: white;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bundle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(196, 165, 118, 0.4);
        }

        /* Premium Option */
        .premium-option {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 2px solid #C4A576;
            border-radius: 16px;
            padding: 24px 20px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .premium-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: linear-gradient(135deg, #C4A576, #D4B996);
            color: #1a1a1a;
            font-size: 11px;
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 0 14px 0 12px;
        }

        .premium-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .premium-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .premium-title {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }

        .premium-subtitle {
            font-size: 13px;
            color: #C4A576;
        }

        .premium-features {
            margin-bottom: 20px;
        }

        .premium-feature {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: #fff;
            font-size: 14px;
        }

        .premium-feature:last-child {
            border-bottom: none;
        }

        .premium-feature-icon {
            color: #C4A576;
            font-weight: 600;
            flex-shrink: 0;
        }

        .premium-feature-text {
            flex: 1;
        }

        .premium-feature-value {
            color: #888;
            font-size: 12px;
        }

        .premium-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .premium-price {
            display: flex;
            flex-direction: column;
        }

        .premium-price-old {
            font-size: 13px;
            color: #888;
            text-decoration: line-through;
        }

        .premium-price-new {
            font-size: 28px;
            font-weight: 700;
            color: #C4A576;
        }

        .premium-price-info {
            font-size: 11px;
            color: #888;
        }

        .premium-btn {
            background: linear-gradient(135deg, #C4A576, #D4B996);
            border: none;
            color: #1a1a1a;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .premium-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(196, 165, 118, 0.5);
        }

        .section-divider {
            text-align: center;
            color: #999;
            font-size: 13px;
            margin: 24px 0;
            position: relative;
        }

        .section-divider::before,
        .section-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 1px;
            background: #E8E8E8;
        }

        .section-divider::before {
            left: 0;
        }

        .section-divider::after {
            right: 0;
        }

        /* Skip */
        .skip {
            text-align: center;
            margin-top: 16px;
        }

        .skip-btn {
            display: inline-block;
            font-size: 14px;
            color: white;
            background: #8B7355;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }

        .skip-btn:hover {
            background: #7A6548;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Success -->
        <div class="success-msg">
            <div class="success-check">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h1>Bestellung best√§tigt!</h1>
            <p>Plan f√ºr <span class="dog-name">Luna</span> ist unterwegs</p>
            <p style="font-size: 15px; font-weight: 600; margin-top: 8px;">Bis dein Plan per E-Mail ankommt, kann es bis zu 20 Minuten dauern üê∂</p>
        </div>

        <!-- Upsell -->
        <div class="upsell-box">
            <div class="limited-offer-banner">
                üéÅ Einmaliges Angebot nur f√ºr Neukunden
            </div>

            <div class="upsell-stat">
                <strong>70% aller Hundebesitzer</strong> w√ºnschen sich sp√§ter, fr√ºher mit Pr√§vention begonnen zu haben.
            </div>

            <div class="upsell-header">
                <div class="upsell-icon">üêï</div>
                <h2>Sichere dir jetzt exklusiv f√ºr <span class="dog-name">Luna</span>:</h2>
            </div>

            <!-- Option 1: Trennungsangst -->
            <div class="upsell-options" id="upsellOptions">
                <!-- Wird dynamisch bef√ºllt -->
            </div>
        </div>

        <div class="skip">
            <a href="#" class="skip-btn">Nein danke, nur meinen Plan</a>
        </div>
    </div>

    <!-- Payment Popup -->
    <div class="payment-overlay" id="paymentOverlay">
        <div class="payment-popup">
            <div class="payment-header">
                <span class="payment-title">Zusatzmodul hinzuf√ºgen</span>
                <button class="payment-close" onclick="closePaymentPopup()">‚úï</button>
            </div>
            <div class="payment-body">
                <div class="payment-product">
                    <div class="payment-product-icon" id="paymentIcon">üò∞</div>
                    <div class="payment-product-info">
                        <h3 id="paymentModuleName">Trennungsangst Pr√§vention</h3>
                        <p>8 √úbungen ‚Ä¢ 2 Wochen</p>
                    </div>
                    <div class="payment-product-price">‚Ç¨19</div>
                </div>

                <!-- Modul Benefits -->
                <div class="payment-benefits" id="paymentBenefits">
                    <div class="payment-benefit">‚úì <span>Alleine-bleiben Training</span></div>
                    <div class="payment-benefit">‚úì <span>Abschiedsrituale</span></div>
                    <div class="payment-benefit">‚úì <span>Ruhe-Signale aufbauen</span></div>
                    <div class="payment-benefit">‚úì <span>Schritt-f√ºr-Schritt Anleitung</span></div>
                </div>

                <div id="paymentError" class="payment-error"></div>

                <div id="payment-element"></div>

                <button class="payment-btn" id="paymentBtn" onclick="submitUpsellPayment()">
                    üîí Jetzt bezahlen
                </button>

                <div class="payment-guarantee">
                    üõ°Ô∏è Sichere Zahlung ‚Ä¢ 30 Tage Geld-zur√ºck
                </div>
            </div>
        </div>
    </div>

    <script>
        const STRIPE_PUBLIC_KEY = 'pk_live_51R4LfjAI8IbKLr6RO63Mf5cZmwW8GZCV8fveuqas0sQU8tVtGGISXj1WxQBN5LjUu7IMt0swCgIp8XEFDFZKqgSI00N5iaRkiy';
        
        // Supabase Config
        const SUPABASE_URL = 'https://xomsibpyksrzrnixbdwf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvbXNpYnB5a3NyenJuaXhiZHdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NjMxMjIsImV4cCI6MjA3MjIzOTEyMn0.ZgCwog94HUHz39lbGMJkFPeZ6c-nL4AMFFTz5AgwnKE';
        
        const dogName = localStorage.getItem('dogName') || 'Luna';
        const dogAge = localStorage.getItem('dogAge') || 'puppy';
        
        // leadId aus URL oder localStorage
        const urlParamsInit = new URLSearchParams(window.location.search);
        const leadId = urlParamsInit.get('lead_id') || localStorage.getItem('leadId') || '';
        console.log('üîç zusatz.html - leadId aus URL:', urlParamsInit.get('lead_id'));
        console.log('üîç zusatz.html - leadId aus localStorage:', localStorage.getItem('leadId'));
        console.log('üîç zusatz.html - verwendete leadId:', leadId);
        
        const userEmail = localStorage.getItem('userEmail') || '';
        const selectedPlan = localStorage.getItem('selectedPlan') || '3month';
        
        let stripe = null;
        let elements = null;
        let paymentElement = null;
        let currentModule = null;
        let clientSecret = null;

        // Modul-Daten mit Benefits
        const moduleData = {
            'anxiety': {
                icon: 'üò∞',
                name: 'Trennungsangst Pr√§vention',
                exercises: '6 √úbungen',
                benefits: ['Alleine-bleiben Training', 'Abschiedsrituale', 'Ruhe-Signale aufbauen', 'Schritt-f√ºr-Schritt Anleitung'],
                desc: 'Bringe deinem Hund bei, entspannt alleine zu bleiben.'
            },
            'pulling': { 
                icon: 'ü¶Æ', 
                name: 'Leinenf√ºhrigkeit Basics', 
                exercises: '6 √úbungen',
                benefits: ['Bei-Fu√ü Training', 'Richtungswechsel-Technik', 'Ablenkungen meistern', 'Entspannte Spazierg√§nge'],
                desc: 'Entspannte Spazierg√§nge von Anfang an ‚Äì ohne Ziehen und Zerren.'
            },
            'barking': { 
                icon: 'üîä', 
                name: 'Anti-Bell Training', 
                exercises: '6 √úbungen',
                benefits: ['Ruhe-Kommando aufbauen', 'Ausl√∂ser erkennen', 'Bellen auf Signal', 'Nachbarschaftsfrieden'],
                desc: 'Kontrolliertes Bellen auf Kommando ‚Äì Ruhe f√ºr dich und deine Nachbarn.'
            },
            'aggression': {
                icon: 'üò§',
                name: 'Aggressions-Kontrolle',
                exercises: '6 √úbungen',
                benefits: ['Trigger-Management', 'Ruhe bewahren lernen', 'Sichere Begegnungen', 'Impulskontrolle'],
                desc: 'Sichere Begegnungen mit anderen Hunden und Menschen.'
            },
            'recall': { 
                icon: 'üì£', 
                name: 'R√ºckruf-Training', 
                exercises: '6 √úbungen',
                benefits: ['Zuverl√§ssiger R√ºckruf', 'Ablenkungstraining', 'Belohnungsaufbau', 'Freilauf erm√∂glichen'],
                desc: 'Zuverl√§ssiger R√ºckruf ‚Äì auch bei Ablenkungen.'
            },
            'jumping': {
                icon: 'üêï',
                name: 'Anti-Anspring Training',
                exercises: '6 √úbungen',
                benefits: ['Ruhige Begr√º√üung', 'Vier-Pfoten-Regel', 'Besuchertraining', 'Impulskontrolle'],
                desc: 'Ruhige Begr√º√üungen ohne wildes Anspringen.'
            },
            'energy': { 
                icon: '‚ö°', 
                name: 'Energie-Management', 
                exercises: '6 √úbungen',
                benefits: ['Ruhe√ºbungen', 'Mentale Auslastung', 'Entspannungssignale', 'Ausgeglichener Alltag'],
                desc: 'Ein ausgeglichener Hund durch gezielte Besch√§ftigung.'
            },
            'destructive': { 
                icon: 'üß∏', 
                name: 'Anti-Zerst√∂rungs Training', 
                exercises: '6 √úbungen',
                benefits: ['Kau-Alternativen', 'Langeweile vermeiden', 'Grenzen setzen', 'Sichere Umgebung'],
                desc: 'Schluss mit kaputten Schuhen und zerst√∂rten M√∂beln.'
            },
            'mouthing': { 
                icon: 'ü¶¥', 
                name: 'Anti-Aufnehm Training', 
                exercises: '6 √úbungen',
                benefits: ['Aus-Kommando aufbauen', 'Impulskontrolle st√§rken', 'Gefahren vermeiden', 'Entspannte Spazierg√§nge'],
                desc: 'Dein Hund lernt, unerw√ºnschte Sachen liegen zu lassen.'
            }
        };

        // Alle Probleme aus localStorage/wauwerk_answers holen
        const answers = JSON.parse(localStorage.getItem('wauwerk_answers') || '{}');
        
        // Alle ausgew√§hlten Probleme sammeln
        const dogGoal = answers.dog_goal || localStorage.getItem('dogProblemKey') || '';
        const dogProblem = answers.dog_problem || localStorage.getItem('dogProblem') || '';
        const dogBehaviors = answers.dog_behaviors || JSON.parse(localStorage.getItem('dogBehaviors') || '[]');
        
        // Alle Probleme kombinieren (ohne Duplikate)
        const allUserProblems = [...new Set([dogGoal, dogProblem, ...dogBehaviors].filter(p => p))];

        console.log('üêï dog_goal:', dogGoal);
        console.log('üêï dog_problem:', dogProblem);
        console.log('üêï dog_behaviors:', dogBehaviors);
        console.log('üêï Alle ausgeschlossenen Probleme:', allUserProblems);

        // Upsell-Optionen rendern (nur die, die der User NICHT hat)
        function renderUpsellOptions() {
            const container = document.getElementById('upsellOptions');
            const allModules = Object.keys(moduleData);
            
            // Filter: Module die der User nicht im Plan hat
            const availableModules = allModules.filter(m => !allUserProblems.includes(m));
            
            // Zeige maximal 2 Optionen f√ºr Einzelmodule
            const modulesToShow = availableModules.slice(0, 2);
            
            if (modulesToShow.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">Du hast bereits alle Module! üéâ</p>';
                return;
            }

            let html = '';
            const firstModule = moduleData[modulesToShow[0]];

            // ========== 1. ERSTES EINZELNES MODUL (‚Ç¨19) ==========
            const pointsHtml = firstModule.benefits.slice(0, 3).map(b => '<span class="option-point">' + b + '</span>').join('');

            html += '<div class="upsell-option">' +
                '<div class="option-header">' +
                    '<div class="option-left">' +
                        '<span class="option-icon">' + firstModule.icon + '</span>' +
                        '<span class="option-name">' + firstModule.name + '</span>' +
                    '</div>' +
                    '<span class="option-badge">' + firstModule.exercises + '</span>' +
                '</div>' +
                '<p class="option-desc">' + firstModule.desc + '</p>' +
                '<div class="option-points">' + pointsHtml + '</div>' +
                '<div class="option-footer">' +
                    '<div class="option-price">' +
                        '<span class="option-price-old">‚Ç¨29</span>' +
                        '<span class="option-price-new">‚Ç¨19</span>' +
                    '</div>' +
                    '<button class="option-btn" onclick="buyUpsell(\'' + modulesToShow[0] + '\')">Hinzuf√ºgen</button>' +
                '</div>' +
            '</div>';

            // ========== 2. ZWEITES EINZELNES MODUL (‚Ç¨19) - falls vorhanden ==========
            if (modulesToShow.length > 1) {
                const secondModule = moduleData[modulesToShow[1]];
                const pointsHtml2 = secondModule.benefits.slice(0, 3).map(b => '<span class="option-point">' + b + '</span>').join('');

                html += '<div class="upsell-option">' +
                    '<div class="option-header">' +
                        '<div class="option-left">' +
                            '<span class="option-icon">' + secondModule.icon + '</span>' +
                            '<span class="option-name">' + secondModule.name + '</span>' +
                        '</div>' +
                        '<span class="option-badge">' + secondModule.exercises + '</span>' +
                    '</div>' +
                    '<p class="option-desc">' + secondModule.desc + '</p>' +
                    '<div class="option-points">' + pointsHtml2 + '</div>' +
                    '<div class="option-footer">' +
                        '<div class="option-price">' +
                            '<span class="option-price-old">‚Ç¨29</span>' +
                            '<span class="option-price-new">‚Ç¨19</span>' +
                        '</div>' +
                        '<button class="option-btn" onclick="buyUpsell(\'' + modulesToShow[1] + '\')">Hinzuf√ºgen</button>' +
                    '</div>' +
                '</div>';
            }

            // ========== 3. BUNDLE OPTION (2 Module f√ºr ‚Ç¨25) - nur wenn 2 Module vorhanden ==========
            if (modulesToShow.length > 1) {
                const secondModule = moduleData[modulesToShow[1]];

                html += '<div class="bundle-option" style="border-color: #E8E8E8; background: #FAFAFA;">' +
                    '<span class="bundle-badge" style="background: #666;">üì¶ BUNDLE</span>' +
                    '<div class="bundle-header">' +
                        '<h3 class="bundle-title">2 Extra-Module f√ºr ' + dogName + '</h3>' +
                        '<p class="bundle-subtitle">' + firstModule.name + ' + ' + secondModule.name + '</p>' +
                    '</div>' +
                    '<div class="bundle-modules">' +
                        '<div class="bundle-module">' +
                            '<span class="bundle-module-icon">' + firstModule.icon + '</span>' +
                            '<div class="bundle-module-info">' +
                                '<h4>' + firstModule.name + '</h4>' +
                                '<div class="bundle-module-points">' +
                                    firstModule.benefits.slice(0, 2).map(b => '<span class="bundle-point">' + b + '</span>').join('') +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="bundle-module">' +
                            '<span class="bundle-module-icon">' + secondModule.icon + '</span>' +
                            '<div class="bundle-module-info">' +
                                '<h4>' + secondModule.name + '</h4>' +
                                '<div class="bundle-module-points">' +
                                    secondModule.benefits.slice(0, 2).map(b => '<span class="bundle-point">' + b + '</span>').join('') +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="bundle-footer">' +
                        '<div class="bundle-price">' +
                            '<span class="bundle-price-old">Statt ‚Ç¨38</span>' +
                            '<span class="bundle-price-new">‚Ç¨25</span>' +
                            '<span class="bundle-price-save">Du sparst ‚Ç¨13!</span>' +
                        '</div>' +
                        '<button class="bundle-btn" style="background: linear-gradient(135deg, #C4A576, #D4B996);" onclick="buyBundle(\'' + modulesToShow[0] + '\', \'' + modulesToShow[1] + '\')">Bundle sichern</button>' +
                    '</div>' +
                '</div>';
            }

            container.innerHTML = html;
        }

        // Upsell-Optionen beim Laden rendern
        renderUpsellOptions();

        // Preise je Plan
        const planPrices = {
            '1month': 29.99,
            '3month': 39.99,
            '6month': 59.99
        };
        const purchaseValue = planPrices[selectedPlan] || 39.99;

        // ==================== PURCHASE TRACKING ====================
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        const paymentIntent = urlParams.get('payment_intent');
        const redirectStatus = urlParams.get('redirect_status');
        
        // NUR wenn redirect_status=succeeded ODER payment_intent vorhanden (Stripe Redirect)
        const isValidPurchase = (redirectStatus === 'succeeded') || (paymentIntent && !redirectStatus);
        
        // Gleicher Key wie in danke.html f√ºr Deduplizierung
        const uniqueKey = paymentIntent || sessionId || leadId || 'unknown';
        const trackingKey = 'wauwerk_purchase_tracked_' + uniqueKey;

        if (isValidPurchase && !localStorage.getItem(trackingKey)) {
            console.log('üî• Purchase Event feuern:', purchaseValue, 'EUR');
            
            // Event ID f√ºr Meta Deduplizierung (STABIL - ohne Date.now() f√ºr korrekte Deduplizierung)
            const eventId = 'purchase_' + uniqueKey;
            
            if (typeof fbq !== 'undefined') {
                fbq('track', 'Purchase', {
                    value: purchaseValue,
                    currency: 'EUR',
                    content_type: 'product',
                    content_ids: ['wauwerk_' + selectedPlan],
                    content_name: 'Pfoten-Plan Trainingsplan ' + selectedPlan,
                    contents: [{
                        id: 'wauwerk_' + selectedPlan,
                        quantity: 1
                    }]
                }, { eventID: eventId });
                console.log('‚úÖ Meta Purchase gefeuert (Event ID:', eventId, ')');
            }

            if (typeof ttq !== 'undefined') {
                ttq.track('CompletePayment', {
                    value: purchaseValue,
                    currency: 'EUR',
                    content_type: 'product',
                    content_name: 'Pfoten-Plan Trainingsplan'
                });
                console.log('‚úÖ TikTok Purchase gefeuert');
            }

            if (typeof gtag !== 'undefined') {
                gtag('event', 'conversion', {
                    'send_to': 'AW-17806525009/I3FdCL3O1NEbENGE6KpC',
                    'value': purchaseValue,
                    'currency': 'EUR',
                    'transaction_id': sessionId || leadId
                });
                gtag('event', 'purchase', {
                    'value': purchaseValue,
                    'currency': 'EUR',
                    'transaction_id': sessionId || leadId
                });
                console.log('‚úÖ Google Purchase gefeuert');
            }

            localStorage.setItem(trackingKey, 'true');
            
            // Status in Supabase auf "paid" setzen
            const updatePaidStatus = async () => {
                let updateUrl = '';
                
                if (leadId) {
                    updateUrl = `${SUPABASE_URL}/rest/v1/wauwerk_leads?id=eq.${leadId}`;
                } else if (userEmail) {
                    // Fallback: nach Email suchen
                    updateUrl = `${SUPABASE_URL}/rest/v1/wauwerk_leads?email=eq.${encodeURIComponent(userEmail)}&order=created_at.desc&limit=1`;
                }
                
                if (updateUrl) {
                    try {
                        const response = await fetch(updateUrl, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            },
                            body: JSON.stringify({
                                status: 'paid',
                                selected_plan: selectedPlan,
                                price: purchaseValue,
                                stripe_payment_intent: paymentIntent || null,
                                paid_at: new Date().toISOString()
                            })
                        });
                        
                        if (response.ok) {
                            console.log('‚úÖ Supabase Status auf "paid" gesetzt');
                        } else {
                            console.error('‚ùå Supabase update failed:', response.status);
                        }
                    } catch (err) {
                        console.error('Supabase update error:', err);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Keine leadId oder Email - kann Status nicht updaten');
                }
            };
            
            updatePaidStatus();
        } else {
            console.log('‚è≠Ô∏è Purchase bereits getrackt, skip');
        }
        // ==================== END TRACKING ====================
        
        document.querySelectorAll('.dog-name').forEach(el => {
            el.textContent = dogName;
        });

        // Dynamische Texte basierend auf Alter
        const ageContent = {
            'puppy': {
                stat: '<strong>70% aller Welpen</strong> entwickeln sp√§ter Verhaltensprobleme.',
                header: 'Da ' + dogName + ' noch ein Welpe ist, kannst du jetzt vorbeugen:'
            },
            'young': {
                stat: '<strong>Junge Hunde lernen am schnellsten.</strong> Schlechte Gewohnheiten jetzt stoppen ist einfacher als sp√§ter.',
                header: 'Da ' + dogName + ' noch jung ist, ist jetzt der beste Zeitpunkt:'
            },
            'adult': {
                stat: '<strong>Auch erwachsene Hunde lernen dazu.</strong> Mit den richtigen Methoden siehst du schnell Fortschritte.',
                header: 'F√ºr ' + dogName + ' empfehlen wir:'
            },
            'senior': {
                stat: '<strong>Alte Hunde, neue Tricks?</strong> Absolut! Sanftes Training funktioniert in jedem Alter.',
                header: 'Speziell f√ºr ' + dogName + ' als √§lteren Hund:'
            }
        };

        const content = ageContent[dogAge] || ageContent['adult'];
        
        document.querySelector('.upsell-header h2').innerHTML = content.header;
        document.querySelector('.upsell-stat').innerHTML = content.stat;

        // Premium kaufen
        async function buyPremium() {
            const btn = document.querySelector('.premium-btn');
            btn.textContent = 'L√§dt...';
            btn.disabled = true;

            currentModule = 'premium';

            // Popup SOFORT √∂ffnen und aktualisieren - mit Trainer-Bild
            document.querySelector('.payment-product').innerHTML = 
                '<div class="payment-trainer-img">' +
                    '<img src="TrainerWau.png" alt="Dein Trainer" style="width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 3px solid #C4A576;">' +
                '</div>' +
                '<div class="payment-product-info">' +
                    '<h3 id="paymentModuleName">Pfoten-Plan Premium</h3>' +
                    '<p>Pers√∂nliche Betreuung f√ºr ' + dogName + '</p>' +
                '</div>' +
                '<div class="payment-product-price" style="font-size: 16px; text-align: right;">' +
                    '<div style="font-size: 18px; font-weight: 700;">‚Ç¨249,99</div>' +
                    '<div style="font-size: 11px; color: #888;">‚âà ‚Ç¨83,33/Monat</div>' +
                '</div>';

            // Premium Benefits - besser erkl√§rt
            const premiumBenefitsHtml = 
                '<div class="payment-benefit">‚úì <span>Leinenf√ºhrigkeit, Anti-Bell, R√ºckruf, Trennungsangst & mehr</span></div>' +
                '<div class="payment-benefit">‚úì <span>3 Monate pers√∂nlicher Support via WhatsApp</span></div>' +
                '<div class="payment-benefit">‚úì <span>Schick Videos ‚Äì bekomm Feedback</span></div>' +
                '<div class="payment-benefit">‚úì <span>W√∂chentliche Check-ins: "Wie l√§uft\'s?"</span></div>';
            document.getElementById('paymentBenefits').innerHTML = premiumBenefitsHtml;

            // WhatsApp Hinweis hinzuf√ºgen
            const whatsappNote = document.createElement('div');
            whatsappNote.style.cssText = 'background: #E8F5E9; border-radius: 8px; padding: 10px 12px; margin-bottom: 12px; font-size: 12px; color: #2E7D32; text-align: center;';
            whatsappNote.innerHTML = 'üì± <strong>Nach dem Kauf:</strong> Du bekommst per Email deine WhatsApp-Zugangsdaten';
            
            const paymentBenefits = document.getElementById('paymentBenefits');
            paymentBenefits.parentNode.insertBefore(whatsappNote, paymentBenefits.nextSibling);

            // Popup Title √§ndern
            document.querySelector('.payment-title').textContent = 'Premium sichern';

            // Popup SOFORT √∂ffnen
            document.getElementById('paymentOverlay').classList.add('active');

            // Check email
            if (!userEmail) {
                alert('Bitte zuerst E-Mail eingeben.');
                btn.textContent = 'Premium sichern';
                btn.disabled = false;
                closePaymentPopup();
                return;
            }

            try {
                console.log('üì§ Premium Checkout:', { leadId, email: userEmail, dogName });
                
                const response = await fetch('/api/upsell-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        module: 'premium',
                        leadId: leadId,
                        email: userEmail,
                        dogName: dogName,
                        price: 24999 // ‚Ç¨249,99 in Cents
                    })
                });

                const result = await response.json();
                console.log('üì• Premium API Response:', result);

                if (result.error) {
                    alert('Fehler: ' + result.error);
                    btn.textContent = 'Premium sichern';
                    btn.disabled = false;
                    closePaymentPopup();
                    return;
                }

                if (!result.clientSecret) {
                    alert('Fehler: Keine Zahlungs-Session erhalten');
                    btn.textContent = 'Premium sichern';
                    btn.disabled = false;
                    closePaymentPopup();
                    return;
                }

                clientSecret = result.clientSecret;

                if (!stripe) {
                    stripe = Stripe(STRIPE_PUBLIC_KEY);
                }

                elements = stripe.elements({
                    clientSecret: clientSecret,
                    appearance: {
                        theme: 'stripe',
                        variables: {
                            colorPrimary: '#C4A576',
                            colorBackground: '#ffffff',
                            colorText: '#2C2C2E',
                            colorDanger: '#e74c3c',
                            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                            borderRadius: '8px'
                        }
                    },
                    locale: 'de'
                });

                paymentElement = elements.create('payment', {
                    layout: { type: 'tabs', defaultCollapsed: false },
                    paymentMethodOrder: ['klarna', 'paypal', 'card'],
                    wallets: { applePay: 'auto', googlePay: 'auto' }
                });

                paymentElement.mount('#payment-element');

                btn.textContent = 'Premium sichern';
                btn.disabled = false;

            } catch (err) {
                console.error('Premium Error:', err);
                alert('Fehler beim Laden. Bitte versuche es erneut.');
                btn.textContent = 'Premium sichern';
                btn.disabled = false;
                closePaymentPopup();
            }
        }

        // Payment Popup √∂ffnen
        async function buyUpsell(module) {
            const btn = event.target;
            btn.textContent = 'L√§dt...';
            btn.disabled = true;

            // Check if email exists
            if (!userEmail) {
                alert('Bitte zuerst E-Mail eingeben.');
                btn.textContent = 'Hinzuf√ºgen';
                btn.disabled = false;
                return;
            }

            currentModule = module;
            const data = moduleData[module] || moduleData['anxiety'];

            // Popup aktualisieren
            document.getElementById('paymentIcon').textContent = data.icon;
            document.getElementById('paymentModuleName').textContent = data.name;
            document.querySelector('.payment-product-info p').textContent = data.exercises + ' ‚Ä¢ 2 Wochen';

            // Benefits aktualisieren
            const benefitsHtml = data.benefits.map(b => '<div class="payment-benefit">‚úì <span>' + b + '</span></div>').join('');
            document.getElementById('paymentBenefits').innerHTML = benefitsHtml;

            try {
                console.log('üì§ Sende an API:', { module, leadId, email: userEmail, dogName });
                
                // PaymentIntent vom Server holen
                const response = await fetch('/api/upsell-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        module: module,
                        leadId: leadId,
                        email: userEmail,
                        dogName: dogName
                    })
                });

                console.log('üì• API Response Status:', response.status);
                const result = await response.json();
                console.log('üì• API Response:', result);

                if (result.error) {
                    alert('Fehler: ' + result.error);
                    btn.textContent = 'Hinzuf√ºgen';
                    btn.disabled = false;
                    return;
                }

                if (!result.clientSecret) {
                    alert('Fehler: Keine Zahlungs-Session erhalten');
                    btn.textContent = 'Hinzuf√ºgen';
                    btn.disabled = false;
                    return;
                }

                clientSecret = result.clientSecret;

                // Stripe initialisieren
                if (!stripe) {
                    stripe = Stripe(STRIPE_PUBLIC_KEY);
                }

                // Stripe Elements erstellen
                elements = stripe.elements({
                    clientSecret: clientSecret,
                    appearance: {
                        theme: 'stripe',
                        variables: {
                            colorPrimary: '#C4A576',
                            colorBackground: '#ffffff',
                            colorText: '#2C2C2E',
                            colorDanger: '#e74c3c',
                            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                            borderRadius: '8px'
                        }
                    },
                    locale: 'de'
                });

                // Payment Element mounten
                paymentElement = elements.create('payment', {
                    layout: { type: 'tabs', defaultCollapsed: false },
                    paymentMethodOrder: ['klarna', 'paypal', 'card'],
                    wallets: { applePay: 'auto', googlePay: 'auto' }
                });

                paymentElement.mount('#payment-element');

                // Popup √∂ffnen
                document.getElementById('paymentOverlay').classList.add('active');

                btn.textContent = 'Hinzuf√ºgen';
                btn.disabled = false;

            } catch (err) {
                console.error('Error:', err);
                alert('Fehler beim Laden. Bitte versuche es erneut.');
                btn.textContent = 'Hinzuf√ºgen';
                btn.disabled = false;
            }
        }

        // Bundle kaufen (beide Module)
        async function buyBundle(module1, module2) {
            const btn = event.target;
            btn.textContent = 'L√§dt...';
            btn.disabled = true;

            if (!userEmail) {
                alert('Bitte zuerst E-Mail eingeben.');
                btn.textContent = 'Bundle sichern';
                btn.disabled = false;
                return;
            }

            currentModule = module1 + '+' + module2; // Bundle: beide Module
            const data1 = moduleData[module1];
            const data2 = moduleData[module2];

            // Popup f√ºr Bundle aktualisieren
            document.getElementById('paymentIcon').textContent = 'üì¶';
            document.getElementById('paymentModuleName').textContent = 'Komplett-Paket';
            document.querySelector('.payment-product-info p').textContent = data1.name + ' + ' + data2.name;
            document.querySelector('.payment-product-price').textContent = '‚Ç¨25';

            // Benefits f√ºr Bundle (je 2 von jedem Modul)
            const bundleBenefits = [
                ...data1.benefits.slice(0, 2),
                ...data2.benefits.slice(0, 2)
            ];
            const benefitsHtml = bundleBenefits.map(b => '<div class="payment-benefit">‚úì <span>' + b + '</span></div>').join('');
            document.getElementById('paymentBenefits').innerHTML = benefitsHtml;

            try {
                console.log('üì§ Bundle Checkout:', { module1, module2, leadId, email: userEmail, bundle: true });

                const response = await fetch('/api/upsell-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        module: module1 + '+' + module2,
                        leadId: leadId,
                        email: userEmail,
                        dogName: dogName,
                        bundle: true,
                        price: 2500 // 25‚Ç¨ in Cents
                    })
                });

                const result = await response.json();
                console.log('üì• Bundle API Response:', result);

                if (result.error) {
                    alert('Fehler: ' + result.error);
                    btn.textContent = 'Bundle sichern';
                    btn.disabled = false;
                    return;
                }

                if (!result.clientSecret) {
                    alert('Fehler: Keine Zahlungs-Session erhalten');
                    btn.textContent = 'Bundle sichern';
                    btn.disabled = false;
                    return;
                }

                clientSecret = result.clientSecret;

                if (!stripe) {
                    stripe = Stripe(STRIPE_PUBLIC_KEY);
                }

                elements = stripe.elements({
                    clientSecret: clientSecret,
                    appearance: {
                        theme: 'stripe',
                        variables: {
                            colorPrimary: '#C4A576',
                            colorBackground: '#ffffff',
                            colorText: '#2C2C2E',
                            colorDanger: '#e74c3c',
                            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                            borderRadius: '8px'
                        }
                    },
                    locale: 'de'
                });

                paymentElement = elements.create('payment', {
                    layout: { type: 'tabs', defaultCollapsed: false },
                    paymentMethodOrder: ['klarna', 'paypal', 'card'],
                    wallets: { applePay: 'auto', googlePay: 'auto' }
                });

                paymentElement.mount('#payment-element');
                document.getElementById('paymentOverlay').classList.add('active');

                btn.textContent = 'Bundle sichern';
                btn.disabled = false;

            } catch (err) {
                console.error('Bundle Error:', err);
                alert('Fehler beim Laden. Bitte versuche es erneut.');
                btn.textContent = 'Bundle sichern';
                btn.disabled = false;
            }
        }

        // Zahlung abschicken
        async function submitUpsellPayment() {
            const payBtn = document.getElementById('paymentBtn');
            payBtn.disabled = true;
            payBtn.innerHTML = '<span class="spinner"></span> Wird verarbeitet...';
            
            hidePaymentError();

            if (!stripe || !elements) {
                showPaymentError('Stripe nicht initialisiert. Bitte Seite neu laden.');
                payBtn.disabled = false;
                payBtn.innerHTML = 'üîí Jetzt bezahlen';
                return;
            }

            try {
                console.log('üí≥ Starte Zahlung...');
                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: window.location.origin + '/danke-zusatz.html?module=' + currentModule + '&lead_id=' + leadId
                    }
                });

                if (error) {
                    console.error('‚ùå Stripe Fehler:', error);
                    showPaymentError(error.message || 'Zahlung fehlgeschlagen');
                    payBtn.disabled = false;
                    payBtn.innerHTML = 'üîí Jetzt bezahlen';
                }
            } catch (err) {
                console.error('‚ùå Catch Fehler:', err);
                showPaymentError('Zahlung fehlgeschlagen. Bitte versuche es erneut.');
                payBtn.disabled = false;
                payBtn.innerHTML = 'üîí Jetzt bezahlen';
            }
        }

        function showPaymentError(message) {
            const errorEl = document.getElementById('paymentError');
            errorEl.textContent = message;
            errorEl.classList.add('visible');
        }

        function hidePaymentError() {
            document.getElementById('paymentError').classList.remove('visible');
        }

        function closePaymentPopup() {
            document.getElementById('paymentOverlay').classList.remove('active');
            // Payment Element unmounten
            if (paymentElement) {
                paymentElement.unmount();
                paymentElement = null;
            }
        }

        // Skip Button ‚Üí normale Danke-Seite
        document.querySelector('.skip-btn').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'danke.html';
        });

        // Overlay schlie√üen bei Klick au√üerhalb
        document.getElementById('paymentOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closePaymentPopup();
            }
        });
    </script>
</body>
</html>